#!/bin/bash
#
#
BU_DEST=~/git.backup
if [ ! -d $BU_DEST ]
then
    mkdir -p $BU_DEST
fi

cd ~/git
find . -maxdepth 1 -type d |
    while read dir
    do
        cd $dir
        git status --porcelain | egrep -v '^\?\?' | awk '{print $2}' |
            while read filePath
            do
                dest="${BU_DEST}/$dir/`dirname $filePath`"
                if [ ! -d "$dest" ]
                then
                    mkdir -p "$dest"
                fi
                echo "$filePath"
                rsync -p "$filePath" "$dest"
            done
        cd ~/git
    done

echo Done.
